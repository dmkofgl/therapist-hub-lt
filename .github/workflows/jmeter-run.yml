name: JMeter Load Test

permissions:
  contents: read
  pages: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      testFile:
        description: 'Relative path to .jmx test file'
        required: true
        default: 'therapist-hub.jmx'
      threads:
        description: 'Number of threads'
        required: true
        default: '1'
      loops:
        description: 'Number of loops'
        required: true
        default: '1'
      rampTime:
        description: 'Ramp-up time in seconds'
        required: true
        default: '1'
      deployWithPAT:
        description: 'Set to "true" to deploy using a personal access token (DEPLOY_PAT secret) via peaceiris (git push). Otherwise uses the official Pages actions.'
        required: false
        default: 'true'

jobs:
  jmeter-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and extract Apache JMeter
        run: |
          set -e
          JMETER_VERSION=5.6.3
          echo "Downloading Apache JMeter ${JMETER_VERSION}..."
          curl -sSL "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz" -o jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-${JMETER_VERSION} jmeter
          ls -la jmeter/bin
          # Download PostgreSQL JDBC driver so JMeter can connect to Postgres during tests
          PGJDBC_VERSION=42.6.0
          echo "Downloading PostgreSQL JDBC driver ${PGJDBC_VERSION}..."
          curl -sSL "https://repo1.maven.org/maven2/org/postgresql/postgresql/${PGJDBC_VERSION}/postgresql-${PGJDBC_VERSION}.jar" -o jmeter/lib/postgresql-${PGJDBC_VERSION}.jar
          ls -la jmeter/lib | head -n 20
      - name: Create db.properties from secrets
        run: |
          # write properties without leading indentation so values are exact
          printf 'db.user=%s\n' "${{ secrets.DB_USER }}" > db.properties
          printf 'db.pass=%s\n' "${{ secrets.DB_PASS }}" >> db.properties
          printf 'db.url=%s\n' "${{ secrets.DB_URL }}" >> db.properties
      - name: Run JMeter (non-GUI)
        run: |
          set -e
          echo "Running JMeter test: '${{ github.event.inputs.testFile }}' with threads=${{ github.event.inputs.threads }} loops=${{ github.event.inputs.loops }} rampTime=${{ github.event.inputs.rampTime }}"
          mkdir -p results
          rm -rf results/report || true
          ./jmeter/bin/jmeter -n \
            -t "${{ github.event.inputs.testFile }}" \
            -q db.properties \
            -l results/results.jtl \
            -e \
            -o results/report \
            -Jthreads="${{ github.event.inputs.threads }}" \
            -Jloops="${{ github.event.inputs.loops }}" \
            -JrampTime="${{ github.event.inputs.rampTime }}"

      - name: Show generated files (debug)
        run: |
          echo "Workspace root:"
          ls -la
          echo "results dir:"
          ls -la results || true
          echo "results/report dir:"
          ls -la results/report || true

      - name: Check report exists
        id: check_report
        run: |
          if [ -d results/report ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Ensure DEPLOY_PAT secret exists
        if: github.event.inputs.deployWithPAT == 'true'
        run: |
          if [ -z "${{ secrets.DEPLOY_PAT }}" ]; then
            echo "ERROR: DEPLOY_PAT secret is not set. Create repository secret DEPLOY_PAT containing a personal access token with repo:contents write access, then re-run this workflow with deployWithPAT=true."
            exit 1
          fi

      - name: Deploy to GitHub Pages (using PAT + peaceiris)
        if: steps.check_report.outputs.report_exists == 'true' && github.event.inputs.deployWithPAT == 'true'
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e
        with:
          personal_token: ${{ secrets.DEPLOY_PAT }}
          publish_dir: results/report
          publish_branch: gh-pages

      - name: Deploy to GitHub Pages (official pages action)
        if: steps.check_report.outputs.report_exists == 'true' && github.event.inputs.deployWithPAT != 'true'
        uses: actions/deploy-pages@f27bcc15848fdcdcc02f01754eb838e44bcf389b
